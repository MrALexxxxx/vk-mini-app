<!DOCTYPE html>
<html>
<head>
    <script>
        function isWebView() {
            return navigator.userAgent.includes("VK") || !!window.AndroidBridge || !!(window.webkit && window.webkit.messageHandlers);
        }

        function isIframe() {
            return window !== window.parent;
        }

        function redirectToWebView() {
            if (isIframe() && !isWebView()) {
                const url = new URL(window.location.href);
                url.searchParams.set('vk_platform', 'mobile_web');
                window.location.href = url.toString();
            }
        }

        function initVkApp() {
            redirectToWebView();
            try {
                if (window.VK) {
                    window.VK.init(() => {
                        console.log("VK API инициализирован!");
                        document.getElementById("startButton").disabled = false;
                    }, error => {
                        console.error("Ошибка инициализации VK API:", error);
                    });
                }
            } catch (error) {
                console.error("Ошибка инициализации VK API:", error);
                document.getElementById('status').innerText = 'Ошибка инициализации VK API';
            }
        }

        async function startBot() {
            try {
                if (window.VK) {
                    window.VK.api("users.get", {}, function(data) {
                        if (data.error) {
                            console.error("Ошибка получения user_id:", data.error);
                            document.getElementById('status').innerText = 'Ошибка получения user_id';
                            return;
                        }
                        const userId = data.response[0].id;

                        document.getElementById('status').innerText = 'Отправка запроса на сервер...';

                        fetch("https://yourserver.com/start_bot", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ user_id: userId })
                        })
                        .then(response => response.json())
                        .then(result => {
                            console.log("Ответ сервера:", result);
                            document.getElementById('status').innerText = 'Бот запущен!';
                        })
                        .catch(error => {
                            console.error("Ошибка при отправке запроса:", error);
                            document.getElementById('status').innerText = 'Ошибка отправки запроса';
                        });
                    });
                }
            } catch (error) {
                console.error("Ошибка запуска бота:", error);
                document.getElementById('status').innerText = 'Ошибка запуска бота';
            }
        }

        document.addEventListener("DOMContentLoaded", initVkApp);
    </script>
</head>
<body>
    <button onclick="startBot()" id="startButton" disabled>Получить консультацию</button>
    <div id="status">Загрузка...</div>
</body>
</html>