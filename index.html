<!DOCTYPE html>
<html>
<head>
    <script>
        function onVkApiLoad() {
            console.log('onVkApiLoad вызван');
            document.getElementById('status').innerText = 'VK API загружен, инициализация...';
            console.log('Начинаем VK.init с apiId:', 53232316);
            console.log('Контекст: window.VK?', !!window.VK, 'WebView?', navigator.userAgent.includes('VK'));

            // Проверяем, является ли это WebView
            const isWebView = navigator.userAgent.includes('VK') || !!window.AndroidBridge || !!(window.webkit && window.webkit.messageHandlers);
            console.log('isWebView:', isWebView);
            console.log('Окружение:', {
                userAgent: navigator.userAgent,
                AndroidBridge: !!window.AndroidBridge,
                IosBridge: !!(window.webkit && window.webkit.messageHandlers)
            });

            if (!isWebView) {
                console.warn('Внимание: VK.init работает только в WebView ВКонтакте. Текущий контекст: браузер.');
                document.getElementById('status').innerText = 'Инициализация возможна только в Mini App ВКонтакте';
                return;
            }

            try {
                VK.init({
                    apiId: 53232316
                }, function() {
                    document.getElementById('status').innerText = 'VK API инициализирован';
                    console.log('VK.init успешно: VK API готов');
                    document.getElementById('startButton').disabled = false;
                }, function(error) {
                    document.getElementById('status').innerText = 'Ошибка инициализации: ' + JSON.stringify(error);
                    console.error('Ошибка VK.init:', error);
                });
            } catch (error) {
                document.getElementById('status').innerText = 'Синхронная ошибка VK.init: ' + error.message;
                console.error('Синхронная ошибка VK.init:', error);
            }

            console.log('Запускаем таймер на 5 секунд');
            setTimeout(() => {
                console.log('Таймер сработал');
                if (document.getElementById('status').innerText === 'VK API загружен, инициализация...') {
                    document.getElementById('status').innerText = 'VK.init не завершил инициализацию';
                    console.error('VK.init не завершил инициализацию после 5 секунд');
                }
            }, 5000);
        }

        function onVkApiError(error) {
            document.getElementById('status').innerText = 'Ошибка загрузки vkapi.js: ' + error.message;
            console.error('Не удалось загрузить vkapi.js:', error);
        }
    </script>
</head>
<body>
    <button onclick="startBot()" disabled id="startButton">Получить консультацию</button>
    <div id="status">Загрузка VK API...</div>
    <script src="https://vk.com/js/api/openapi.js" onload="onVkApiLoad()" onerror="onVkApiError(event)"></script>
    <script>
        console.log('DOM загружен, начинаем загрузку vkapi.js');
        try {
            document.getElementById('status').innerText = 'Попытка загрузки vkapi.js...';
        } catch (e) {
            console.error('Ошибка перед загрузкой:', e);
        }

        function startBot() {
            document.getElementById('status').innerText = 'Получение user_id...';
            console.log('Вызываем VK.callMethod для users.get');
            VK.callMethod('users.get', {}, function(data) {
                if (data.error) {
                    document.getElementById('status').innerText = 'Ошибка users.get: ' + data.error.error_msg;
                    console.error('Ошибка users.get:', data.error);
                    return;
                }
                const userId = data.response[0].id;
                document.getElementById('status').innerText = 'Отправка сообщения для user_id: ' + userId;
                console.log('Получен userId:', userId);

                console.log('Вызываем VK.api для messages.send');
                VK.api('messages.send', {
                    user_id: userId,
                    message: 'Bot started',
                    random_id: Math.floor(Math.random() * 2147483647),
                    access_token: 'vk1.a.F1Ns-Kx8tVjXslJ5oKyTzCcRMZz2QfINNHw8E76i3q3jmdYiDcndumIB_po7_tBikskIR3gir1AsqjrOAdA0HW8hAaoERXUq5uunamlYyfheuOeS-17-rnVml5TxsMMP1_V6KxApQCEgvQcyGCfamS4hbsXB12KwY3U-w0H5xU0AdeJfhjLQp4DSo9R1LUMZM6dLPe3Jsfjw47hjC3slHA',
                    v: '5.199'
                }, function(response) {
                    if (response.response) {
                        document.getElementById('status').innerText = 'Бот запущен!';
                        console.log('Сообщение отправлено:', response);
                    } else {
                        document.getElementById('status').innerText = 'Ошибка messages.send: ' + response.error.error_msg;
                        console.error('Ошибка messages.send:', response.error);
                    }
                });
            });
        }
    </script>
</body>
</html>